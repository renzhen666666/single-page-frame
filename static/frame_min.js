const app=document.getElementById("app");function loadingElement(){const loadingElement=document.createElement("div");loadingElement.className="text-center";const ldinner=document.createElement("div");ldinner.className="spinner-border";ldinner.setAttribute("role","status");const srOnly=document.createElement("span");srOnly.className="visually-hidden";srOnly.textContent="åŠ è½½ä¸­...";ldinner.appendChild(srOnly);loadingElement.appendChild(ldinner);return loadingElement.outerHTML}function toggleTheme(){const currentTheme=document.documentElement.getAttribute("data-theme");let newTheme;const themeToggle=document.getElementById("theme-toggle");const themeIcon=themeToggle?.querySelector(".theme-icon");if(currentTheme==="light"){document.documentElement.setAttribute("data-theme","dark");newTheme="dark";if(themeIcon)themeIcon.textContent="â˜€ï¸"}else{document.documentElement.setAttribute("data-theme","light");newTheme="light";if(themeIcon)themeIcon.textContent="ğŸŒ™"}localStorage.setItem("theme",newTheme)}function initThemeToggle(){const themeToggle=document.getElementById("theme-toggle");const themeIcon=themeToggle?.querySelector(".theme-icon");const currentTheme=localStorage.getItem("theme")||"dark";if(currentTheme==="light"){document.documentElement.setAttribute("data-theme","light");if(themeIcon)themeIcon.textContent="ğŸŒ™"}else{document.documentElement.setAttribute("data-theme","dark");if(themeIcon)themeIcon.textContent="â˜€ï¸"}if(themeToggle){themeToggle.addEventListener("click",toggleTheme)}}function initTheme(){const currentTheme=localStorage.getItem("theme")||"dark";if(currentTheme==="light"){document.documentElement.setAttribute("data-theme","light")}else{document.documentElement.setAttribute("data-theme","dark")}}document.addEventListener("menuLoaded",initThemeToggle);function jumpTo(url){if(url.startsWith("/")){if(url==="/")url="/home";window.history.pushState({},"",url);loadPage()}else{window.open(url,"_blank")}}const loading=loadingElement();let navHtml=``;let menuHtml=``;const defaultMethods={toggleTheme:toggleTheme};initTheme();document.addEventListener("DOMContentLoaded",()=>{if(window.location.pathname==="/")window.location.pathname="/home";loadPage()},false);async function loadScriptFromSrc(pageName){try{const pageModule=await import(`./js/${pageName}`);if(typeof pageModule.init==="function"){pageModule.init()}else{console.warn(`é¡µé¢ ${pageName} ç¼ºå°‘ init å‡½æ•°`)}return pageModule.methods||{}}catch(error){console.error(`åŠ è½½é¡µé¢ ${pageName} å¤±è´¥:`,error);return{}}}function loadScript(scriptContent){return new Promise((resolve,reject)=>{const script=document.createElement("script");script.innerText=scriptContent;script.async=true;script.setAttribute("data-loaded-from",window.location.pathname);script.onload=()=>resolve(script);script.onerror=()=>reject(new Error(`Failed to load script: ${scriptContent}`));document.head.appendChild(script)})}function loadStyles(href){return new Promise((resolve,reject)=>{if(document.querySelector(`link[href="${href}"]`)){resolve();return}const link=document.createElement("link");link.rel="stylesheet";link.href=href;link.type="text/css";link.onload=()=>{resolve(link)};link.setAttribute("data-loaded-from",window.location.pathname);link.onerror=()=>reject(new Error(`Failed to load CSS: ${href}`));document.head.appendChild(link)})}async function clearOldPage(){window.__pageCleanup?.();clearTimeout(window.__pageTimers);document.querySelectorAll("link").forEach(link=>{if(link.getAttribute("data-loaded-from")&&link.getAttribute("data-loaded-from")!==window.location.pathname){link.remove()}});document.querySelectorAll("script").forEach(script=>{if(script.getAttribute("data-loaded-from")&&script.getAttribute("data-loaded-from")!==window.location.pathname){script.remove()}})}async function loadPage(){app.innerHTML=loading;const path=window.location.pathname;const cleanP=clearOldPage();try{const response=await fetch(`/api/pages${path}`,{method:"POST"});const data=await processResponse(response);console.log(`${path} data:`,data);var methodsMap=defaultMethods;if(data.config.scripts){const methodsPromises=data.config.scripts.map(scriptSrc=>loadScriptFromSrc(scriptSrc));const methodsArray=await Promise.all(methodsPromises);methodsArray.forEach(_methods=>{Object.assign(methodsMap,_methods)})}await cleanP;if(data.htmlscripts){loadScript(data.htmlscripts)}if(data.config.styles){const stylesPromises=data.config.styles.map(cssFilename=>loadStyles(`/css/${cssFilename}`));await Promise.all(stylesPromises)}await loadNavigation(data.config);renderPage(data.page,data.config,methodsMap=methodsMap);window.dispatchEvent(new Event("pageLoaded"))}catch(error){console.error("åŠ è½½é¡µé¢å¤±è´¥:",error)}}function renderPage(pageHtml,config,methodsMap={}){app.innerHTML=pageHtml;if(config?.title)document.title=config.title;document.querySelectorAll("[data-on-click]").forEach(element=>{const methodName=element.getAttribute("data-on-click");const handler=methodsMap[methodName];if(typeof handler==="function"){element.addEventListener("click",handler)}else{console.warn(`æ‰¾ä¸åˆ°æ–¹æ³•: ${methodName}`,methodsMap)}});const as=document.querySelectorAll("a:not([data-bound])");as.forEach(a=>{a.setAttribute("data-bound","true");a.addEventListener("click",e=>{e.preventDefault();const href=a.getAttribute("href");jumpTo(href)})})}async function loadNavigation(config={}){try{if(!navHtml){const navResponse=await fetch("/api/navigation",{method:"POST"});const navData=await navResponse.json();navHtml=navData.data.nav;menuHtml=navData.data.menu}document.getElementById("nav").innerHTML=renderTemplate(navHtml,config.nav||{});document.getElementById("menu").innerHTML=renderTemplate(menuHtml,config.menu||{});document.dispatchEvent(new Event("menuLoaded"))}catch(error){console.error("åŠ è½½å¯¼èˆªæ å¤±è´¥:",error)}}function renderTemplate(content,data={}){content=content.replace(/\{([^}]+)\}([\s\S]*?)\{\/\1\}/g,(match,key,innerContent)=>{return data[key]?innerContent:""});content=content.replace(/\{([^}]+)\}/g,(match,key)=>{return data[key]!==undefined?data[key]:""});return content}async function processResponse(response){const data=await response.json();if(!data.success){console.error("APIè¿”å›é”™è¯¯:",data.error||"æœªçŸ¥é”™è¯¯");if(data.data?.page){return data.data}else{return{page:`<div class="alert alert-danger" role="alert">å‡ºç°é—®é¢˜ï¼Œ è¯·ç¨åå†è¯•</div>`}}}return data.data}