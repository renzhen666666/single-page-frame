const app=document.getElementById("app");function loadingElement(){const loadingElement=document.createElement("div");loadingElement.className="text-center";const ldinner=document.createElement("div");ldinner.className="spinner-border";ldinner.setAttribute("role","status");const srOnly=document.createElement("span");srOnly.className="visually-hidden";srOnly.textContent="åŠ è½½ä¸­...";ldinner.appendChild(srOnly);loadingElement.appendChild(ldinner);return loadingElement.outerHTML}const loading=loadingElement();let navHtml=``;let menuHtml=``;function toggleTheme(){const currentTheme=document.documentElement.getAttribute("data-theme");let newTheme;if(currentTheme==="light"){document.documentElement.setAttribute("data-theme","dark");newTheme="dark";if(themeIcon)themeIcon.textContent="â˜€ï¸"}else{document.documentElement.setAttribute("data-theme","light");newTheme="light";if(themeIcon)themeIcon.textContent="ğŸŒ™"}localStorage.setItem("theme",newTheme)}function initTheme(){const themeToggle=document.getElementById("theme-toggle");const themeIcon=themeToggle?.querySelector(".theme-icon");const currentTheme=localStorage.getItem("theme")||"dark";if(currentTheme==="light"){document.documentElement.setAttribute("data-theme","light");if(themeIcon)themeIcon.textContent="ğŸŒ™"}else{document.documentElement.setAttribute("data-theme","dark");if(themeIcon)themeIcon.textContent="â˜€ï¸"}if(themeToggle){themeToggle.addEventListener("click",toggleTheme)}}document.addEventListener("DOMContentLoaded",initTheme);document.addEventListener("DOMContentLoaded",()=>{if(window.location.pathname==="/")window.location.pathname="/home";loadNavigation();loadPage()},false);async function loadPage(){window.__pageCleanup?.();clearTimeout(window.__pageTimers);app.innerHTML=loading;const path=window.location.pathname;try{const response=await fetch(`/api/pages${path}`,{method:"POST"});const data=await processResponse(response);app.innerHTML=data.page;console.log(`${path} data:`,data);loadNavigation(data.config);if(data.scripts&&Array.isArray(data.scripts)){data.scripts.forEach(scriptContent=>{try{const script=document.createElement("script");script.textContent=scriptContent;document.head.appendChild(script);document.head.removeChild(script)}catch(e){console.error("æ‰§è¡Œé¡µé¢è„šæœ¬æ—¶å‡ºé”™:",e)}})}}catch(error){console.error("åŠ è½½é¡µé¢å¤±è´¥:",error)}const as=document.querySelectorAll("a:not([data-bound])");as.forEach(a=>{a.setAttribute("data-bound","true");a.addEventListener("click",e=>{e.preventDefault();const href=a.getAttribute("href");jumpTo(href)})})}function jumpTo(url){if(url.startsWith("/")){if(url==="/")url="/home";window.history.pushState({},"",url);loadPage()}else{window.open(url,"_blank")}}async function loadNavigation(config={}){try{if(!navHtml){const navResponse=await fetch("/api/navigation",{method:"POST"});const navData=await navResponse.json();navHtml=navData.data.nav;menuHtml=navData.data.menu}document.getElementById("nav").innerHTML=renderTemplate(navHtml,config.nav||{});document.getElementById("menu").innerHTML=renderTemplate(menuHtml,config.menu||{})}catch(error){console.error("åŠ è½½å¯¼èˆªæ å¤±è´¥:",error)}}function renderTemplate(content,data={}){content=content.replace(/\{([^}]+)\}([\s\S]*?)\{\/\1\}/g,(match,key,innerContent)=>{return data[key]?innerContent:""});content=content.replace(/\{([^}]+)\}/g,(match,key)=>{return data[key]!==undefined?data[key]:match});return content}async function processResponse(response){const data=await response.json();if(!data.success){console.error("APIè¿”å›é”™è¯¯:",data.error||"æœªçŸ¥é”™è¯¯");if(data.data?.page){return data.data}else{return{page:`<div class="alert alert-danger" role="alert">å‡ºç°é—®é¢˜ï¼Œ è¯·ç¨åå†è¯•</div>`}}}return data.data}